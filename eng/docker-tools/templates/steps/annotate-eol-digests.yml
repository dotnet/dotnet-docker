parameters:
- name: acr
  type: object
# Path to EOL annotation data JSON file generated by 'generateEolAnnotationData*' command
- name: dataFile
  type: string

steps:
  - script: mkdir -p $(Build.ArtifactStagingDirectory)/annotation-digests
    displayName: Create Annotation Digests Directory
  - template: /eng/docker-tools/templates/steps/run-imagebuilder.yml@self
    parameters:
      displayName: Annotate EOL Images (${{ parameters.acr.server }})
      serviceConnections:
      - name: acr
        id: ${{ parameters.acr.serviceConnection.id }}
        tenantId: ${{ parameters.acr.serviceConnection.tenantId }}
        clientId: ${{ parameters.acr.serviceConnection.clientId }}
      internalProjectName: internal
      condition: and(succeeded(), eq(variables['publishEolAnnotations'], 'true'))
      args: >-
        annotateEolDigests
        "${{ parameters.dataFile }}"
        "${{ parameters.acr.server }}"
        "${{ parameters.acr.repoPrefix }}"
        $(artifactsPath)/annotation-digests/annotation-digests.txt
        $(dryRunArg)
  - template: /eng/docker-tools/templates/steps/publish-artifact.yml@self
    parameters:
      path: $(Build.ArtifactStagingDirectory)/annotation-digests
      artifactName: annotation-digests-${{ parameters.acr.server }}-$(System.JobAttempt)
      displayName: Publish Annotation Digests List (${{ parameters.acr.server }})
      internalProjectName: internal
      publicProjectName: public
      condition: and(succeeded(), eq(variables['publishEolAnnotations'], 'true'))
  - template: /eng/docker-tools/templates/steps/run-imagebuilder.yml@self
    parameters:
      displayName: Wait for Annotation Ingestion (${{ parameters.acr.server }})
      serviceConnections:
      - name: mar
        id: $(marStatus.serviceConnection.id)
        tenantId: $(marStatus.serviceConnection.tenantId)
        clientId: $(marStatus.serviceConnection.clientId)
      internalProjectName: internal
      condition: and(succeeded(), eq(variables['publishEolAnnotations'], 'true'), eq(variables['waitForIngestionEnabled'], 'true'))
      args: >-
        waitForMarAnnotationIngestion
        $(artifactsPath)/annotation-digests/annotation-digests.txt
