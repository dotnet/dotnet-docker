parameters:
  publishConfig: null
  internalProjectName: null

steps:
- ${{ if and(eq(variables['System.TeamProject'], parameters.internalProjectName), ne(variables['Build.Reason'], 'PullRequest')) }}:
  - powershell: |
      if ("$env:ONEESPT_BUILDTYPE" -eq "Unofficial")
      {
        echo "Build is from an unofficial pipeline, continuing..."
        exit 0
      }

      $isOfficialBranch = "$(officialBranches)".Split(',').Contains("$(sourceBranch)")
      $hasOfficialBranchPrefix = $false
      foreach ($prefix in "$(officialBranchPrefixes)".Split(',')) {
        if ("$(sourceBranch)".StartsWith($prefix)) {
          $hasOfficialBranchPrefix = $true
          break
        }
      }

      if (($isOfficialBranch -or $hasOfficialBranchPrefix) `
          -and "$(officialRepoPrefixes)".Split(',').Contains("${{ parameters.publishConfig.publishAcr.repoPrefix }}"))
      {
        echo "Conditions met for official build, continuing..."
        exit 0
      }

      if (-not "$(officialRepoPrefixes)".Split(',').Contains("${{ parameters.publishConfig.publishAcr.repoPrefix }}"))
      {
        echo "This build is a test build, continuing..."
        exit 0
      }

      if ("${{ variables['overrideOfficialBranchValidation'] }}" -eq "true")
      {
        echo "Variable overrideOfficialBranchValidation is set to true, continuing..."
        exit 0
      }

      echo "##vso[task.logissue type=error]Official builds must be done from an official branch ($(officialBranches)) and repo prefix ($(officialRepoPrefixes))."
      echo "Build definition: $(Build.DefinitionName)"
      echo "1ESPT build type: $(OneESPT.BuildType)"
      echo "Current branch: $(sourceBranch)"
      echo "Publish repo prefix: ${{ parameters.publishConfig.publishAcr.repoPrefix }}"
      exit 1
    displayName: Validate Branch
