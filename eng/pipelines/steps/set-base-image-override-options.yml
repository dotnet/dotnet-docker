parameters:
  # Name of the pipeline variable to append the options to
  variableName: null

steps:
# Configures Image Builder options to override the base image tags for Ubuntu as defined in the Dockerfiles
# and instead use the corresponding image from the Ubuntu ACR.
- powershell: |
    # Because the Ubuntu ACR doesn't have arch-specific tags, we configure the regex and substitution
    # to strip off the arch for the repo name. (e.g. "amd64/ubuntu:jammy" becomes "ubuntu.azurecr.io/ubuntu:jammy")".
    # These tags are multi-arch tags so they'll work across all the architectures we provide.
    $baseOverrideRegex = ".*\/(ubuntu:.+)"

    # Be sure to use the string literal syntax here (single quote) to avoid $1 being interpreted as a variable
    $baseOverrideSubstitution = 'ubuntu.azurecr.io/$1'

    # Assume the variable already exists and append to it. This allows us to dynamically append additional
    # options to a general purpose variable.
    $options = "$(${{ parameters.variableName }})"
    $options += " --base-override-regex '$baseOverrideRegex' --base-override-sub '$baseOverrideSubstitution'"
    echo "##vso[task.setvariable variable=${{ parameters.variableName }}]$options"
  displayName: Set Base Image Override Options
