parameters:
  buildRepoPath: $(System.DefaultWorkingDirectory)/$(Build.Repository.Name)

steps:
- task: UseDotNet@2
  displayName: Install .NET 8.0 SDK
  inputs:
    packageType: sdk
    version: 8.0.x
    installationPath: '${{ parameters.buildRepoPath }}/.dotnet'

- task: UseDotNet@2
  displayName: Install .NET 6.0 runtime
  inputs:
    packageType: runtime
    version: 6.0.x
    installationPath: '${{ parameters.buildRepoPath }}/.dotnet'

- powershell: .dotnet/dotnet tool restore --tool-manifest .config/dotnet-tools.json
  workingDirectory: ${{ parameters.buildRepoPath }}
  displayName: Restore secret-manager

- task: AzureCLI@2
  inputs:
    azureSubscription: DotNet Eng Services Secret Manager
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      Get-ChildItem .vault-config/*.yaml |% { .dotnet/dotnet secret-manager synchronize --verify-only $_}
    workingDirectory: ${{ parameters.buildRepoPath }}
  displayName: Verify Secret Synchronization

