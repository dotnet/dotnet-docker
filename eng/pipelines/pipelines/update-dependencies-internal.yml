parameters:
# Build ID of the .NET staging pipeline to fetch updates from. This can be a
# pipeline run of the real staging pipeline or the staging test pipeline, but
# the stagingStorageAccount parameter must match which pipeline is used here.
- name: buildId
  type: string
  default: ""
# Staging storage account for .NET release artifacts
- name: stagingStorageAccount
  type: string
  default: ""
# A pull request will be created targeting this branch.
- name: targetBranch
  type: string
  default: ""
# Service connection details to use for git operations. This must represent a
# managed identity user that has "contributor" access to the target branch.
- name: gitServiceConnectionName
  type: string
  default: ""

extends:
  template: /eng/docker-tools/templates/1es.yml@self
  parameters:
    stages:
    - stage: UpdateDepsStage
      displayName: Update dotnet

      jobs:
      - template: /eng/pipelines/jobs/update-dependency.yml@self
        parameters:
          dependencyName: dotnet
          updateSteps:
          - task: AzureCLI@2
            displayName: Update .NET
            continueOnError: False
            condition: and(succeeded(), true)
            inputs:
              azureSubscription: "${{ parameters.gitServiceConnectionName }}"
              scriptType: "pscore"
              scriptLocation: "inlineScript"
              inlineScript: >-
                dotnet run --project eng/update-dependencies/update-dependencies.csproj --
                from-staging-pipeline
                ${{ parameters.buildId }}
                --mode Remote
                --azdo-organization "$(System.CollectionUri)"
                --azdo-project "$(System.TeamProject)"
                --azdo-repo "$(Build.Repository.Name)"
                --internal
                --staging-storage-account ${{ parameters.stagingStorageAccount }}
                --target-branch "${{ parameters.targetBranch }}"
                --user "$(dotnetDockerBot.userName)"
                --email "$(dotnetDockerBot.email)"
            env:
              # Used to download build artifacts from .NET release staging pipeline
              SYSTEM_ACCESSTOKEN: $(System.AccessToken)
