# Contributing

See [dotnet/runtime Contributing](https://github.com/dotnet/runtime/blob/master/CONTRIBUTING.md) for information about coding styles, source structure, making pull requests, and more.

## Branches

When making PRs, all source code changes (e.g. Dockerfiles, tests, and infrastructure) should be made in the [nightly branch](https://github.com/dotnet/dotnet-docker/tree/nightly). Only changes to the samples and documentation will be accepted against the [main branch](https://github.com/dotnet/dotnet-docker/tree/main).

## Workflow Instructions

### Building

The [`build-and-test.ps1`](https://github.com/dotnet/dotnet-docker/blob/main/build-and-test.ps1) script will build and test the .NET Docker images. Given the matrix of supported .NET versions, distros, and architectures there are numerous Dockerfiles and building can take a while. To make this manageable, the script supports several options for filtering down what images get built and tested.

- Build and test all of the .NET 5.0 images for the Docker platform your machine is targeting (e.g. linux/x64, linux/arm, linux/arm64, windows/x64).

    ``` console
    > ./build-and-test.ps1 -Version 5.0
    ```

- Build the 3.1 Nano Server 1809 images

    ``` console
    > ./build-and-test.ps1 -Version 3.1 -OS nanoserver-1809 -Mode Build
    ```

- Build and test the samples

    ``` console
    > ./build-and-test.ps1 -Path *samples* -TestCategories sample
    ```

- Test the 5.0 Alpine 3.13 images for the current architecture (e.g. x64, arm, arm64).

    ``` console
    > ./build-and-test.ps1 -Version 5.0 -OS alpine3.13 -Mode Test
    ```

### Editing Dockerfiles

The [Dockerfiles](https://github.com/search?q=repo%3Adotnet%2Fdotnet-docker+filename%3ADockerfile&type=Code&ref=advsearch&l=&l=) contained in this repo are generated from a set of [Cottle](https://cottle.readthedocs.io/en/stable/page/01-overview.html) based [templates](https://github.com/dotnet/dotnet-docker/tree/main/eng/dockerfile-templates). A single template generates the set of Dockerfiles that are similar (e.g. all Windows sdk Dockerfiles for a particular .NET version).  This ensures consistency across the various Dockerfiles and eases the burden of making changes to the Dockerfiles.  Instead of editing the Dockerfiles directly, the templates should be updated and then the Dockerfiles should get regenerated by running the [generate Dockerfiles script](https://github.com/dotnet/dotnet-docker/blob/main/eng/dockerfile-templates/Get-GeneratedDockerfiles.ps1).

### Editing READMEs

The [READMEs](https://github.com/search?q=repo%3Adotnet%2Fdotnet-docker+filename%3AREADME+path%3A%2F&type=Code&ref=advsearch&l=&l=) contained in this repo are used as the descriptions for the Docker repositories the images are published to.  Just like the Dockerfiles, the READMEs are generated from a set of [Cottle](https://cottle.readthedocs.io/en/stable/page/01-overview.html) based [templates](https://github.com/dotnet/dotnet-docker/tree/main/eng/readme-templates).  This ensures consistency across the various READMEs and eases the burden of making changes.  Instead of editing the READMEs directly, the templates should be updated and then the READMEs should get regenerated by running the [generate READMEs script](https://github.com/dotnet/dotnet-docker/blob/main/eng/readme-templates/Get-GeneratedReadmes.ps1).

### Tests

There are two basic types of [tests](https://github.com/dotnet/dotnet-docker/tree/main/tests) for each of the images produced from this repo.

1. Unit tests that validate the static state of images.  This includes things like verifing which environment variables are defined.
1. Scenario tests that validate basic usage scenarios.  For example the SDK image is used to create, build and run a new console app.

When editing Dockerfiles, please ensure the appropriate test changes are also made.

### Metadata Changes

The [`manifest.json`](https://github.com/dotnet/dotnet-docker/blob/main/manifest.json) contains metadata used by the engineering infrastructure to build and publish the images.  It includes information such as:

- Dockerfiles to build
- Image Tags
- Manifest/shared tags to create and which images they reference
- Docker repositories to publish the images to
- Dockerfile templates used to generate the Dockerfiles
- etc.

When adding or removing Dockerfiles, it is important to update the `manifest.json` accordingly.

### Updating Product Versions

Updating the product versions (e.g. .NET runtime, ASP.NET runtime, PowerShell, etc.) contained within the images is typically performed by automation. All of the product version information is stored in the [`manifest.versions.json`](https://github.com/dotnet/dotnet-docker/blob/main/manifest.versions.json) file. The Dockerfile templates reference the product versions numbers and checksums from this file. Updating a product version involves updating the `manifest.versions.json` and regenerating the Dockerfiles. If there are cases where you need to update a product version, you can use the [update-dependencies](https://github.com/dotnet/dotnet-docker/tree/main/eng/update-dependencies) tool.  The tool will do the following:

1. Update the product versions and checksums stored in `manifest.versions.json`
1. Regenerate the Dockerfiles
1. Update the tags listing in the readmes

The following examples illustrate how to run `update-dependencies`:

- Update the 3.1 product versions (uses a helper script for running update-dependencies)

    ``` console
    > ./eng/Set-DotnetVersions.ps1 -ProductVersion 3.1 -SdkVersion 3.1.302 -RuntimeVersion 3.1.6 -AspnetVersion 3.1.6
    ```

- Update the .NET Monitor version

    ``` console
    > dotnet run --project .\eng\update-dependencies\update-dependencies.csproj 5.0 --product-version monitor=5.0.0-preview.5.21277.3 --channel-name 5.0/preview.5
    ```

- Update the PowerShell version used in the 5.0 images

    ``` console
    > dotnet run --project .\eng\update-dependencies\ -- 5.0 --product-version powershell=7.1.0-preview.4 --compute-shas
    ```
